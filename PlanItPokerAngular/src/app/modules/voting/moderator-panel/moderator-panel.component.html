<ng-container *ngIf="playerRole() === PlayerRole.MODERATOR">
  <div class="controls-container">

    <!-- Loading state -->
    <ng-container *ngIf="connectionState.loading()">
      <div class="loading">
        <div class="spinner"></div>
        <span>Loading...</span>
      </div>
    </ng-container>

    <!-- Header with settings -->
    <div class="moderator-header">
      <h5>Session Controls</h5>
      <button type="button" class="a-button a-button--tertiary -without-label" aria-label="accessibility label" (click)="openRoomSettingsDialog()">
        <i class="a-icon a-button__icon boschicon-bosch-ic-settings"></i>
      </button>
    </div>

    <!-- Main Controls -->
    <ng-container *ngIf="!connectionState.loading() && !connectionState.error()">

      <!-- No session active -->
      <div *ngIf="voteSession() == null" class="controls-section">
        <ng-container *ngIf="hasActiveStory().length > 0; else noActiveStory">
          <button type="button" class="a-button a-button--primary -without-icon" (click)="handleAction('start')">
            <span class="a-button__label">Start Voting</span>
          </button>
        </ng-container>
        <ng-template #noActiveStory>
          <div class="info-message">
            Create a story in order to start voting.
          </div>
        </ng-template>
      </div>

      <!-- Session Loaded -->
      <ng-container *ngIf="sessionLoaded()">
        <div *ngIf="voteSession() as session">

          <!-- Active session, not revealed -->
          <div *ngIf="session.status === 'ACTIVE' && !session.revealed" class="controls-section">
            <div class="button-group">
              <button type="button" class="a-button a-button--primary -without-icon"
                (click)="handleAction('flipCards')">
                <span class="a-button__label">Reveal Votes</span>
              </button>

              <button type="button" class="a-button a-button--secondary -without-icon"
                (click)="handleAction('clearVotes')">
                <span class="a-button__label">Clear Votes</span>
              </button>

              <button type="button" class="a-button a-button--danger -without-icon" (click)="handleAction('skipStory')">
                <span class="a-button__label">Skip Story</span>
              </button>
            </div>
          </div>

          <!-- Revealed votes -->
          <div *ngIf="session.status === 'ACTIVE' && session.revealed" class="controls-section">

            <div class="result-section">      
              <div class="result-display-box">
                <div class="result-value">{{ result() }}</div>
              </div>
              </div>

              <div class="button-group">
              <div class="a-dropdown a-dropdown">
                <label for="finalResult">Select final value:</label>
                <ng-container *ngIf="result() as res">
                  <ng-container *ngIf="cards() as cardList">
                    <select id="finalResult" aria-label="Select final result" [(ngModel)]="selectedResult">
                      <option *ngIf="!cardList.includes(res.toString())" [value]="res" disabled hidden>
                        {{ res }} (not in cards)
                      </option>
                      <option *ngFor="let card of cardList" [value]="card">
                        {{ card }}
                      </option>
                    </select>
                  </ng-container>
                </ng-container>
              </div>

          
            <div class="button-group">
              <button type="button" class="a-button a-button--success -without-icon"
                (click)="handleAction('finishVoting', selectedResult)">
                <span class="a-button__label">Finalize Voting</span>
              </button>
            </div>
          </div>
          
          </div>

          <!-- Voting completed -->
          <div *ngIf="session.status === 'COMPLETED'" class="controls-section">
            <div class="button-group">
              <button type="button" class="a-button a-button--secondary -without-icon"
                (click)="handleAction('clearVotes')">
                <span class="a-button__label">Clear Votes</span>
              </button>

              <button type="button" class="a-button a-button--primary -without-icon" (click)="handleAction('start')">
                <span class="a-button__label">Next Story</span>
              </button>
            </div>
          </div>
        </div>

        <!-- No session fallback -->
        <div *ngIf="!voteSession()" class="error-message">
          No active voting session!
        </div>
      </ng-container>
    </ng-container>

    <!-- Error state -->
    <ng-container *ngIf="connectionState.error()">
      <div class="error-message">Eroare de conexiune!</div>
    </ng-container>

  </div>
</ng-container>